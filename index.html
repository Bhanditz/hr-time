<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>High Resolution Time Level 2</title>
  <script src='//www.w3.org/Tools/respec/respec-w3c-common' async class='remove'></script>
  <script class='remove'>
  var respecConfig = {
    shortName: "hr-time-2",
    specStatus: "ED",
    edDraftURI: "https://w3c.github.io/hr-time/",
    editors: [{
      name: "Ilya Grigorik",
      mailto: "igrgiroik@google.com",
      company: "Google Inc.",
      note: "for version 2",
      w3cid: "56102"
    }, {
      name: "James Simonsen",
      mailto: "simonjam@google.com",
      company: "Google Inc.",
      note: "for version 1",
      w3cid: "45726"
    }, {
      name: "Jatinder Mann",
      mailto: "jmann@microsoft.com",
      company: "Microsoft Corp.",
      note: "Until February 2014",
      w3cid: "44357"
    }],
    wg: "Web Performance Working Group",
    wgURI: "http://www.w3.org/2010/webperf/",
    wgPublicList: "public-web-perf",
    subjectPrefix: "[hr-time]",
    otherLinks: [{
      key: 'Repository',
      data: [{
        value: 'We are on Github.',
        href: 'https://github.com/w3c/hr-time/'
      }, {
        value: 'File a bug.',
        href: 'https://github.com/w3c/hr-time/issues'
      }, {
        value: 'Commit history.',
        href: 'https://github.com/w3c/hr-time/commits/gh-pages/index.html'
      }, {
        value: 'Tests.',
        href: 'https://github.com/w3c/web-platform-tests/tree/master/hr-time'
      }]
    }],
    wgPatentURI:  "http://www.w3.org/2004/01/pp-impl/45211/status"
  };
  </script>
</head>

<body>

<section id="abstract">

<p>
	This specification defines a JavaScript interface that provides the current time
	in sub-millisecond resolution and such that it is not subject to system clock skew or adjustments.
</p>

</section>

<section id="sotd">


<p>This is a <strong>work in progress</strong> and may change without any
notices. </p>

<p>
	High Resolution Time Level 2 builds on the first version of High Resolution Time [[HR-TIME]] and includes:
</p>

<ul>
  <li>provides the base definition for the <a>Performance</a> interface, including support for the <a>now</a> method in Web Workers [[WORKERS]];</li>
  <li>introduces <a>translateTime</a> to translate timestamps between different time origins and deprecates <code>workerStart</code> attribute;</li>
</ul>

</section>

<section id="introduction" class='informative'>
<h2>Introduction</h2>

<p>
The ECMAScript Language specification [[ECMA-262]] defines the Date object as a time value representing time in milliseconds since 01 January, 1970 UTC. For most purposes, this definition of time is sufficient as
these values represent time to millisecond precision for any instant that is within approximately 285,616 years from
01 January, 1970 UTC. The <a href="http://www.w3.org/TR/WebIDL/#common-DOMTimeStamp">DOMTimeStamp</a> is defined similarly [[WebIDL]].
</p>

<p>
In practice, these definitions of time are subject to both clock skew and adjustment of the system clock. The value of time may not always be monotonically increasing and subsequent values may either decrease
or remain the same.
</p>

<p>
	For example, the following script may log a positive number, negative number, or zero.
  </p>
	<pre class='example highlight'>
var mark_start = Date.now();
doTask(); // Some task
if (window.console) window.console.log('Duration of task: ' + (Date.now() - mark_start));
	</pre>


<p>
For certain tasks this definition of time may not be sufficient as it does not allow for sub-millisecond resolution and is subject to system clock skew. For example,
</p>
<ul>
	<li>
		When attempting to accurately measure the elapsed time of navigating to a Document, fetching of resources or execution of script, a monotonically increasing clock
		with sub-millisecond resolution is desired.
	</li>
	<li>
		When calculating the animation state from script, developers will need to accurately know the amount of time that has elapsed in the animation in order to properly update the
		next scene of the animation.
	</li>
	<li>
		When calculating the frame rate of a script based animation, developers will need sub-millisecond resolution in order to determine if an animation is drawing at 60 FPS.
		Without sub-millisecond resolution, a developer can only determine if an animation is drawing at 58.8 FPS or 62.5 FPS.
	</li>
	<li>
		In order to cue audio to a specific point in an animation or ensure that the audio is synchronized with the animation,
		developers will need to accurately know the amount of time elapsed in the animation and audio.
	</li>
</ul>

<p>
This specification does not propose changing the behavior of <code>Date.now()</code> [[ECMA-262]] as it is genuinely useful in determining the current value of the calendar time and has a long history of
usage. The <a>DOMHighResTimeStamp</a> type and the <a>now</a> method of the
<a>Performance</a> interface resolve the issues summarized in this section by providing a monotonically increasing time value in sub-millisecond resolution.
</p>

<section id='examples' class='informative'>
<h3>Examples</h3>

<p>A developer may wish to construct a timeline of their entire application, including events from <a href="http://www.w3.org/TR/workers/#worker">dedicated</a> or <a href="http://www.w3.org/TR/workers/#sharedworker">shared workers</a>, which have a different <a>time origin</a>. To display such events on the same timeline, the application can translate the <a title="DOMHighResTimeStamp"><code>DOMHighResTimeStamps</code></a> from the worker with the <a>translateTime</a> method.</p>

<pre class="example highlight">

// ---- worker.js -----------------------------
// Shared worker script
onconnect = function(e) {
  var port = e.ports[0];
  port.onmessage = function(e) {
    // Time execution in worker
    var task_start = performance.now();
    result = runSomeWorkerTask();
    var task_end = performance.now();

    port.postMessage({
       'task': 'Some worker task',
       'start_time': task_start,
       'end_time': task_end,
       'result': result
    });
  }
}

// ---- application.js ------------------------
// Timing tasks in the document
var task_start = performance.now();
result = runSomeWorkerTask();
var task_end = performance.now();

plotEventOnTimeline({
  'task': 'Some document task',
  'start_time': task_start,
  'end_time': task_end,
  'result': result
});

// Translating worker timestamps into document's time origin
var worker = new SharedWorker('worker.js');
worker.port.onmessage = function (event) {
  var msg = event.data;

  // translate timestamps into document's time origin
  msg.start_time = performance.translateTime(msg.start_time, worker);
  msg.end_time = performance.translateTime(msg.end_time, worker);

  // plot the results on document's timeline
  plotEventOnTimeline(msg);
}
</pre>

</section>

<section  id="conformance">

<p>Some conformance requirements are phrased as requirements on attributes,
methods or objects. Such requirements are to be interpreted as requirements
on user agents. </p>

    <p>The IDL fragments in this specification must be interpreted as
    required for conforming IDL fragments, as described in the Web IDL
    specification. [[!WebIDL]]</p>

<section id="terminology">
<h2>Terminology</h2>
<p>The term "JavaScript" is used to refer to ECMA262, rather than the
official term ECMAScript, since the term JavaScript is more widely known. [[ECMA-262]]</p>
</section>
</section>

<section id='high-resolution-time'>
<h2>High Resolution Time</h2>

<section id="high-resolution-introduction" class='informative'>
<h3>Introduction</h3>

<p>
	This specification defines an interface that provides the current time
	in sub-millisecond resolution and such that it is not subject to system clock skew or adjustments.
</p>

</section>

<section>
<h3>Time Origin</h3>

<p>The <i><dfn id="time-origin">time origin</dfn></i> is the time value from which time is measured.</p>

<ul>
  <li>If the <a href="http://www.w3.org/TR/html5/webappapis.html#global-object">global object</a> specified by the incumbent settings object is a <code>Window</code> object, the <i>time origin</i> must be equal to the time of starting the <a href="http://www.w3.org/TR/html5/browsers.html#navigate">navigation</a> responsible for loading the current document, unless a confirmation dialog is displayed during the <a href="http://www.w3.org/TR/html5/browsers.html#prompt-to-unload-a-document">prompt to unload</a> algorithm, in which case the time of the user confirming the navigation must be used instead. If there is no previous document, the time origin must be equal to the time when the <a href="https://html.spec.whatwg.org/multipage/browsers.html#creating-a-new-browsing-context">browsing context is first created</a>.</li>
  <li>If the <a href="http://www.w3.org/TR/html5/webappapis.html#global-object">global object</a> specified by the incumbent settings object is a <code>WorkerGlobalScope</code> object, the <i>time origin</i> must be equal to the <a href="https://w3c.github.io/workers/#official-moment-of-creation">official moment of creation</a> of the worker.</li>
  <li>Otherwise, the <i>time origin</i> is undefined.</li>
</ul>

<h3 id="sec-DOMHighResTimeStamp"><span class="secno">4.3 </span>The <code>DOMHighResTimeStamp</code> Type</h3>
<p>
	The <a><code>DOMHighResTimeStamp</code></a> type is used to store a time value measured relative from the
	<i><a>time origin</a></i> or a time value that represents a duration
	between two  <a title="DOMHighResTimeStamp">DOMHighResTimeStamps</a>.
</p>

<pre class='idl'>
typedef double DOMHighResTimeStamp;
</pre>

<p>A <dfn id="dom-domhighrestimestamp"><code>DOMHighResTimeStamp</code></dfn> SHOULD represent a time in milliseconds accurate to a microsecond.</p>

<p class='note'>
If the User Agent is unable to provide a time value accurate to a microsecond due to hardware or software constraints, the User Agent
can represent a <a>DOMHighResTimeStamp</a> as a time in milliseconds accurate to a millisecond.
</p>

</section>

<section>

<h3>The <code>Performance</code> interface</h3>

<dl title='[Exposed=(Window,Worker)] interface Performance : EventTarget' class='idl'>

<dt>DOMHighResTimeStamp now()</dt>
<dd>
<p>The <dfn id="dom-performance-now"><code>now</code></dfn> method MUST
	return a <a>DOMHighResTimeStamp</a> representing the time in milliseconds
	from the <a>time origin</a> to the occurrence of the call to the <a>now</a> method.
</p>
</dd>

<dt>DOMHighResTimeStamp translateTime(DOMHighResTimeStamp time, (Window or Worker or SharedWorker or ServiceWorker) timeSource)</dt>
<dd>
<p>The <dfn id="dom-performance-translateTime"><code>translateTime</code></dfn> method MUST return a <a>DOMHighResTimeStamp</a> that is the result of adding the provided <code>time</code>, and the difference between the <a>time origin</a> of the provided <code>timeSource</code> and the <a>time origin</a> of the global of the performance object that is the <code>this</code> value for the <a>translateTime</a> call.
</p>

<p class='note'>
  To translate the timestamp (<code>time</code>), the equation is: <code>time + ((time origin of timeSource) - (time origin for the <i>translateTime</i> call))</code>.
</p>
</dd>
</dl>

</section>

<section id="monotonic-clock">
<h3>Monotonic Clock</h3>

<p>
The time values returned when calling the <a>now</a> method MUST be monotonically increasing and not subject to system clock
adjustments or system clock skew. The difference between any two chronologically recorded time values returned from the
<a>now</a> method MUST never be negative.
</p>
</section>

<section id="privacy-security">

<h3>Privacy and Security</h3>
<p>
Statistical fingerprinting is a privacy concern where a malicious web site may determine whether a user has visited a
third-party web site by measuring the timing of cache hits and misses of resources in the third-party web site.
Though the <a>now</a> method of the <a>Performance</a> interface
returns time data to a greater accuracy than before, it does not make this privacy concern significantly worse than it was already.
</p>

</section>
</section>

<section class="appendix">
<h2>Acknowledgments</h2>
<p>I would like to sincerely thank Karen Anderson, Nat Duca, Tony Gentilcore, Arvind Jain, Jason Weber, and Boris Zbarsky to acknowledge their contributions to this work.</p>
</section>
</body>
</html>
