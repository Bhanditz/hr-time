<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>High Resolution Time Level 2</title>
  <script src='//www.w3.org/Tools/respec/respec-w3c-common' async class=
  'remove'>
  </script>
  <script class='remove'>
  var respecConfig = {
    shortName: "hr-time-2",
    specStatus: "ED",
    edDraftURI: "https://w3c.github.io/hr-time/",
    editors: [{
      name: "Ilya Grigorik",
      mailto: "igrigorik@gmail.com",
      company: "Google Inc.",
      w3cid: "56102"
    }, {
      name: "James Simonsen",
      mailto: "simonjam@google.com",
      company: "Google Inc.",
      note: "Until January 2015",
      w3cid: "45726"
    }, {
      name: "Jatinder Mann",
      mailto: "jmann@microsoft.com",
      company: "Microsoft Corp.",
      note: "Until February 2014",
      w3cid: "44357"
    }],
    wg: "Web Performance Working Group",
    wgURI: "https://www.w3.org/webperf/",
    wgPublicList: "public-web-perf",
    subjectPrefix: "[hr-time]",
    otherLinks: [{
      key: 'Repository',
      data: [{
        value: 'We are on Github.',
        href: 'https://github.com/w3c/hr-time/'
      }, {
        value: 'File a bug.',
        href: 'https://github.com/w3c/hr-time/issues'
      }, {
        value: 'Commit history.',
        href: 'https://github.com/w3c/hr-time/commits/gh-pages/index.html'
      }]
    },{
      key: 'Mailing list',
      data: [{
        value: 'public-web-perf@w3.org',
        href: 'https://lists.w3.org/Archives/Public/public-web-perf/'
      }]
    },{
      key: 'Implementation',
      data: [{
        value: 'Can I use High Resolution Time?',
        href: 'http://caniuse.com/#feat=high-resolution-time'
      }, {
        value: 'Test Suite',
        href: 'http://w3c-test.org/hr-time/'
      }, {
        value: 'Test Suite repository',
        href: 'https://github.com/w3c/web-platform-tests/tree/master/hr-time'
      }]
    }],
    localBiblio:  {
      'CACHE-ATTACKS': {
        title: 'The Spy in the Sandbox - Practical Cache Attacks in Javascript',
        href: 'http://arxiv.org/abs/1502.07373',
        authors: [
          'Yossef Oren',
          'Vasileios P. Kemerlis',
          'Simha Sethumadhavan',
          'Angelos D. Keromytis'
        ],
        date: 'March 2015'
      }
    },
    wgPatentURI:  "https://www.w3.org/2004/01/pp-impl/45211/status"
  };
  </script>
</head>
<body>
  <section id="abstract">
    <p>This specification defines an API that provides the current time in
    sub-millisecond resolution and such that it is not subject to system clock
    skew or adjustments.</p>
  </section>
  <section id="sotd">
    <p>High Resolution Time Level 2 replaces the first version of High
    Resolution Time [[HR-TIME]] and includes:</p>
    <ul>
      <li>Defines a precise definition of <a>time origin</a> for the purpose of
      all performance timeline related specifications;
      </li>
      <li>The base definition for the <a>Performance</a> interface, previously specified in [[PERFORMANCE-TIMELINE]],
       is now moved to this specification and now includes support for the <a>Performance.now</a> method in Web Workers
      [[WORKERS]];
      </li>
      <li>To mitigate <a href='#privacy-security'>cache attacks</a>, the
      recommended minimum resolution of the Performance interface should be set
      to 5 microseconds.
      </li>
    </ul>
  </section>
  <section id="introduction" class='informative'>
    <h2>Introduction</h2>
    <p>The ECMAScript Language specification [[ECMA-262]] defines the Date
    object as a time value representing time in milliseconds since 01 January,
    1970 UTC. For most purposes, this definition of time is sufficient as these
    values represent time to millisecond precision for any instant that is
    within approximately 285,616 years from 01 January, 1970 UTC. The <a href=
    "https://www.w3.org/TR/WebIDL/#common-DOMTimeStamp">DOMTimeStamp</a> is
    defined similarly [[WebIDL]].</p>
    <p>In practice, these definitions of time are subject to both clock skew
    and adjustment of the system clock. The value of time may not always be
    monotonically increasing and subsequent values may either decrease or
    remain the same.</p>
    <p>For example, the following script may log a positive number, negative
    number, or zero.</p>
    <pre class='example highlight'>
var mark_start = Date.now();
runSomeApplicationTask();

if (window.console)
  window.console.log('Duration of task: ' + (Date.now() - mark_start));</pre>
    <p>For certain tasks this definition of time may not be sufficient as it
    does not allow for sub-millisecond resolution and is subject to system
    clock skew. For example,</p>
    <ul>
      <li>When attempting to accurately measure the elapsed time of navigating
      to a Document, fetching of resources or execution of script, a
      monotonically increasing clock with sub-millisecond resolution is
      desired.</li>
      <li>When calculating the animation state from script, developers will
      need to accurately know the amount of time that has elapsed in the
      animation in order to properly update the next scene of the
      animation.</li>
      <li>When calculating the frame rate of a script based animation,
      developers will need sub-millisecond resolution in order to determine if
      an animation is drawing at 60 FPS. Without sub-millisecond resolution, a
      developer can only determine if an animation is drawing at 58.8 FPS or
      62.5 FPS.</li>
      <li>In order to cue audio to a specific point in an animation or ensure
      that the audio is synchronized with the animation, developers will need
      to accurately know the amount of time elapsed in the animation and
      audio.</li>
    </ul>
    <p>This specification does not propose changing the behavior of
    <code>Date.now()</code> [[ECMA-262]] as it is genuinely useful in
    determining the current value of the calendar time and has a long history
    of usage. The <a>DOMHighResTimeStamp</a> type and the
    <a>Performance.now</a> method of the <a>Performance</a> interface resolve
    the issues summarized in this section by providing a monotonically
    increasing time value in sub-millisecond resolution.</p>
    <section id='examples' class='informative'>
      <h3>Example</h3>
      <p>A developer can record and report a high-resolution timeline of their
      application for further offline analysis.</p>
      <pre class="example highlight">
var task_start = performance.now();
runSomeApplicationTask();
var task_end = performance.now();

// developer provided method to upload runtime performance data
reportEventToAnalytics({
  'task': 'Some document task',
  'start_time': task_start,
  'duration': task_end - task_start
});
</pre>
    </section>
  </section>
  <section id="conformance">
    <p>Some conformance requirements are phrased as requirements on attributes,
    methods or objects. Such requirements are to be interpreted as requirements
    on user agents.</p>
    <p>The IDL fragments in this specification must be interpreted as required
    for conforming IDL fragments, as described in the Web IDL specification.
    [[!WebIDL]]</p>
  </section>
  <section>
    <h3>Time Origin</h3>
    <p>The <dfn id="time-origin">time origin</dfn> is the time value from which
    time is measured:</p>
    <ul>
      <li>If the <a href=
      "https://www.w3.org/TR/html51/webappapis.html#global-object">global
      object</a> [[!HTML51]] is a <code>Window</code> object, the <a>time
      origin</a> must be equal to:
        <ul>
          <li>the time when the <a href=
          "https://www.w3.org/TR/html51/browsers.html#creating-a-new-browsing-context">
            browsing context is first created</a> if there is no previous
            document;
          </li>
          <li>otherwise, the time of the user confirming the navigation if a
          confirmation dialog is displayed during the <a href=
          "https://www.w3.org/TR/html51/browsers.html#prompt-to-unload-a-document">
            prompt to unload</a> algorithm;
          </li>
          <li>otherwise, the time of starting the <a href=
          "https://www.w3.org/TR/html51/browsers.html#navigate">navigation</a>
          responsible for loading the <a href=
          "https://www.w3.org/TR/html51/browsers.html#dom-document-2">Window
          object's newest Document object</a>.
          </li>
        </ul>
      </li>
      <li>If the <a href=
      "https://www.w3.org/TR/html51/webappapis.html#global-object">global
      object</a> is a <a href=
      "https://w3c.github.io/workers/#the-workerglobalscope-common-interface">
        <code>WorkerGlobalScope</code></a> object, the <a>time origin</a> must
        be equal to the <a href=
        "https://w3c.github.io/workers/#official-moment-of-creation">official
        moment of creation</a> of the worker. [[!WORKERS]]
      </li>
      <li>Otherwise, the <a>time origin</a> is undefined.
      </li>
    </ul>
  </section>
  <section id="dom-domhighrestimestamp">
    <h3>The <code>DOMHighResTimeStamp</code> Type</h3>
    <p>The <a>DOMHighResTimeStamp</a> type is used to store a time value
    measured relative from the <a>time origin</a> or a time value that
    represents a duration between two <a>DOMHighResTimeStamp</a>s.</p>
    <pre class='idl'>
typedef double DOMHighResTimeStamp;
</pre>
    <p>A <a>DOMHighResTimeStamp</a> SHOULD represent a time in milliseconds
    accurate to 5 microseconds - see <a href="#privacy-security"></a>.</p>
    <p class='note'>If the User Agent is unable to provide a time value
    accurate to 5 microseconds due to hardware or software constraints, the
    User Agent can represent a <a>DOMHighResTimeStamp</a> as a time in
    milliseconds accurate to a millisecond.</p>
  </section>
  <section>
    <h3>The <code>Performance</code> interface</h3>
    <pre class='idl'>
[Exposed=(Window,Worker)]
interface Performance : EventTarget {
    DOMHighResTimeStamp now ();
    serializer = {attribute};
};
</pre>
    <p>The <dfn for='Performance' data-lt='now'>now()</dfn> method MUST return
    a <a>DOMHighResTimeStamp</a> representing the time in milliseconds from the
    <a>time origin</a> to the occurrence of the call to the
    <a>Performance.now</a> method.</p>
  </section>
  <section>
    <h3>The <code>performance</code> attribute</h3>
    <p>The <a>GlobalPerformance.performance</a> attribute allows access to
    performance related attributes and methods from the <a href=
    "https://www.w3.org/TR/html51/webappapis.html#global-object">global
    object</a>.</p>
    <pre class='idl'>
[NoInterfaceObject, Exposed=(Window,Worker)]
interface GlobalPerformance {
    [Replaceable]
    readonly    attribute Performance performance;
};

Window implements GlobalPerformance;
WorkerGlobalScope implements GlobalPerformance;
</pre>
  </section>
  <section id="monotonic-clock">
    <h3>Monotonic Clock</h3>
    <p>The time values returned when calling the <a>Performance.now</a> method
    on <a>Performance</a> objects with the same <a>time origin</a> MUST be
    monotonically increasing and not subject to system clock adjustments or
    system clock skew. The difference between any two chronologically recorded
    time values returned from the <a>Performance.now</a> method MUST never be
    negative if the two time values have the same <a>time origin</a>.
  </section>
  <section id="privacy-security">
    <h3>Privacy and Security</h3>
    <p>Access to accurate timing information, both for measurement and
    scheduling purposes, is a common requirement for many applications. For
    example, coordinating animations, sound, and other activity on the page
    requires access to high-resolution time to provide a good user experience.
    Similarly, measurement enables developers to track the performance of
    critical code components, detect regressions, and so on.</p>
    <p>However, access to the same accurate timing information can sometimes be
    also used for malicious purposes by an attacker to guess and infer data
    that they can't see or access otherwise. For example, cache attacks and
    statistical fingerprinting is a privacy and security concern where a
    malicious web site may use high resolution timing data of various browser
    or application-initiated operations to differentiate between subset of
    users, and in some cases identify a particular user - see
    [[CACHE-ATTACKS]].</p>
    <p>This specification defines an API that provides sub-millisecond time
    resolution, which is more accurate than the previously available
    millisecond resolution exposed by <a href=
    "https://www.w3.org/TR/WebIDL/#common-DOMTimeStamp">DOMTimeStamp</a>.
    However, even without this new API an attacker may be able to obtain
    high-resolution estimates through repeat execution and statistical
    analysis. To ensure that the new API does not significantly improve the
    accuracy or speed of such attacks, the recommended minimum resolution of
    the <a>Performance</a> interface should be set to 5 microseconds.</p>
    <p>Mitigating such timing side channel attacks entirely is practically not
    possible: either all operations would have to execute in a time that does
    not vary based on the value of any confidential information, or, the
    application would need to be isolated from any time-related primitives
    (clock, timers, counters, etc). Neither is practical due to the associated
    complexity for the browser and application developers and the associated
    negative effects on performance and responsiveness of applications.</p>
  </section>
  <section class="appendix">
    <h2>Acknowledgments</h2>
    <p>Thanks to
    Arvind Jain,
    Angelos D. Keromytis,
    Boris Zbarsky,
    Jason Weber,
    Karen Anderson,
    Nat Duca,
    Philippe Le Hegaret,
    Ryosuke Niwa,
    Simha Sethumadhavan,
    Todd Reifsteck,
    Tony Gentilcore,
    Vasileios P. Kemerlis,
    Yoav Weiss, and
    Yossef Oren
    for their contributions to this work.</p>
  </section>
</body>
</html>
